---
import BaseLayout from "../layouts/BaseLayout.astro";
import ProfileCard from "../components/ProfileCard.astro";
import BlogPostList from "../components/BlogPostList.astro";
import { getCollection } from "astro:content";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";

// Fetch blog posts from the 'blog' collection
const allPostsRaw = await getCollection("blog");

// Filter posts to ensure they have a valid publication date and map to the structure expected by BlogPostList
const validPosts = allPostsRaw
  .filter((post) => post.data.date instanceof Date) // Ensure date is a valid Date
  .map((post) => ({
    slug: post.id, // Use post.id for the slug (assuming this is correct)
    // Ensure properties match the 'Post' type expected by BlogPostList
    title: post.data.title,
    description: post.data.description, // Use 'description'
    date: post.data.date, // Use 'date' and ensure it's a Date object
    author: post.data.author, // Pass author if needed by BlogPostList (check component props)
    draft: post.data.draft, // Pass draft status
    body: post.body ?? '', // Ensure body is a string, provide fallback
    // Add any other properties from the schema if BlogPostList expects them
  }));

// Page metadata using constants
const title = SITE_TITLE;
const description = SITE_DESCRIPTION;
---
<BaseLayout title={title} description={description}>
    <ProfileCard />
    <section class="mt-16" aria-labelledby="recent-posts-heading">
        <h2 id="recent-posts-heading" class="mb-8 text-2xl font-bold">Recent Posts</h2>
        <BlogPostList posts={validPosts} postsPerPage={3} showSeeMore={true} />
    </section>
</BaseLayout>